{% extends "base.html" %}

{% block content %}
<section class="analysis">
    <h1>Wardrobe Analysis</h1>

    <div class="analysis-card">
        <h2 class="head">Total Items</h2>
        <p class="value">{{ total_item_value }}</p>
        <p class="subtitle">Items in your wardrobe</p>
    </div>

    <div class="analysis-card">
        <h2 class="head">Outfits Created</h2>
        <p class="value">{{ outfits_created_value }}</p>
        <p class="subtitle">Saved outfit combinations</p>
    </div>

    <h2 class="section-title">Most Used Item</h2>
    <div class="most-used-item-block">
        <img src="{{ item_image_url }}" alt="Most used item" class="most-used-item-image">
        <div class="most-used-item-info">
            <h3>{{ item_name | default('No item yet') }}</h3>
            <p>Used in {{ number_of_mixed_outfits | default(0) }} outfits</p>
        </div>
    </div>

    <h2 class="section-title">Style Analysis</h2>
    <div class="graph-style-analysis">
        <canvas id="category-chart" width="400" height="400"></canvas>
        <canvas id="season-chart" width="400" height="400"></canvas>
        <canvas id="color-chart" width="400" height="400"></canvas>
    </div>
</section>

<script>
    async function fetchDataAndRenderCharts() {
        const response = await fetch('/analysis/data');
        const data = await response.json();
    
        const fallbackData = {
            labels: ['No data'],
            datasets: [{
                data: [1],
                backgroundColor: ['#e0e0e0']
            }]
        };
    
        const fallbackOptions = (title) => ({
            plugins: {
                title: {
                    display: true,
                    text: title
                }
            }
        });
    
        new Chart(document.getElementById('category-chart'), {
            type: 'doughnut',
            data: Object.keys(data.category_counts).length ? {
                labels: Object.keys(data.category_counts),
                datasets: [{
                    data: Object.values(data.category_counts),
                    backgroundColor: ['#4F81BD', '#A6A6A6', '#F79646', '#9BBB59', '#8064A2']
                }]
            } : fallbackData,
            options: fallbackOptions('Wardrobe by Category')
        });
    
        new Chart(document.getElementById('season-chart'), {
            type: 'doughnut',
            data: Object.keys(data.season_counts).length ? {
                labels: Object.keys(data.season_counts),
                datasets: [{
                    data: Object.values(data.season_counts),
                    backgroundColor: ['#92D050', '#FFD966', '#F4B183', '#9DC3E6']
                }]
            } : fallbackData,
            options: {
                rotation: -90,
                circumference: 180,
                ...fallbackOptions('Wardrobe by Season')
            }
        });
    
        new Chart(document.getElementById('color-chart'), {
            type: 'bar',
            data: Object.keys(data.color_counts).length ? {
                labels: Object.keys(data.color_counts), // e.g., ['Red', 'Green', 'Blue']
                datasets: [{
                    data: Object.values(data.color_counts),
                    backgroundColor: Object.keys(data.color_counts).map(color => color.toLowerCase()),
                    borderColor: '#ccc',
                    borderWidth: 1
                }]
            } : {
                labels: ['No data'],
                datasets: [{
                    data: [0],
                    backgroundColor: ['#e0e0e0'],
                    borderColor: '#ccc',
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Wardrobe by Color'
                    },
                    legend: {
                        display: false // ðŸ”’ Hides legend ("Number of Items")
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y} items`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Colors'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return Number.isInteger(value) ? value : null;
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Items'
                        }
                    }
                }
            }
        });
    }
    
    fetchDataAndRenderCharts();
</script>

{% endblock %}
